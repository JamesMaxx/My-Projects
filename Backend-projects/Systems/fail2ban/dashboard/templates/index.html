<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>fail2ban Dashboard</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="container">
      <h1>fail2ban Dashboard</h1>
      <div id="controls">
        <h3>Add SSH server</h3>
        <form id="add-server" onsubmit="return addServer(event)">
          <input name="name" placeholder="Name (optional)" />
          <input name="host" placeholder="Host (ip or hostname)" required />
          <input name="user" placeholder="SSH user" required />
          <input name="port" placeholder="Port (22)" />
          <input name="key_path" placeholder="Key path (on dashboard host)" />
          <input name="password" placeholder="Password (not recommended)" />
          <button>Add</button>
        </form>
      </div>

      <div id="servers"></div>
    </div>
    <script>
      async function fetchStatus() {
        const res = await fetch('/api/status');
        const data = await res.json();
        const out = document.getElementById('servers');
        out.innerHTML = '';
        data.forEach(s => {
          const el = document.createElement('div');
          el.className = 'server';
          if (s.error) {
            el.innerHTML = `<h2>${s.name || s.host}</h2><div class="error">${s.error}</div>`;
            out.appendChild(el);
            return;
          }
          let html = `<h2>${s.name || s.host}</h2>`;
          s.jails.forEach(j => {
            html += `<div class="jail"><strong>${j.jail}</strong> (bantime: ${j.bantime_seconds || 0}s)`;
            if (!j.banned || j.banned.length === 0) html += '<div class="none">No banned IPs</div>';
            else {
              html += '<ul>';
              j.banned.forEach(ip => {
                const rem = ip.remaining_seconds === null ? 'unknown' : formatDuration(ip.remaining_seconds);
                html += `<li>${ip.ip} â€” remaining: ${rem} ${ip.banned_at ? ' (since '+ip.banned_at+')' : ''}</li>`;
              });
              html += '</ul>';
            }
            html += '</div>';
          });
          el.innerHTML = html;
          out.appendChild(el);
        });
      }

      function formatDuration(s) {
        if (s === 0) return 'expired';
        if (s < 60) return s + 's';
        const m = Math.floor(s / 60);
        const sec = s % 60;
        if (m < 60) return `${m}m ${sec}s`;
        const h = Math.floor(m / 60);
        const mm = m % 60;
        return `${h}h ${mm}m`;
      }

      async function addServer(e) {
        e.preventDefault();
        const f = e.target;
        const data = {};
        for (const el of f.elements) {
          if (!el.name) continue;
          if (el.value) data[el.name] = el.value;
        }
        const res = await fetch('/api/servers', {method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
        if (res.ok) {
          alert('Added');
          f.reset();
          fetchStatus();
        } else {
          alert('Failed to add server');
        }
        return false;
      }

      // poll every 10s
      fetchStatus();
      setInterval(fetchStatus, 10000);
    </script>
  </body>
</html>
